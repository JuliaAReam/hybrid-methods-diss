\chapter{Numerical Methods}
\section{Introduction}
To discretize and evolve the system of partial differential equations, including the \gls{les} \gls{sgs} terms, we use \textit{PeleC} \cite{PeleC1, PeleC2}. \textit{PeleC} is a highly scalable code for heterogeneous architectures that is being developed as part of the \gls{ecp} through the \gls{doe}. For spatial discretization, \textit{PeleC} contains a few variations of the general \gls{ppm} originally derived by Colella and Woodward \cite{1984JCoPPPM}. We utilize a variation that allows for extrema preservation in the presence of steep gradients \cite{MILLER200226, COLELLA20087069}. \textit{PeleC} also has two options available time-stepping: an explicit second-order \gls{mol} formulation and an iterative scheme base on a \gls{sdc} approach \cite{}. For this work, we use the \gls{sdc} method where the time step is dynamically limited using a Courant number of 0.9. 

The rest of this chapter is outlined as follows: first we introduce the general finite volume formulation for conservative systems as this forms the basis of \textit{PeleC}, with an additional note on the foundations in \textit{AMReX}. The remaining sections cover the numerical methods chosen from those available in \textit{PeleC}, with motivation provided as to why they were selected for this work and a basic overview of the method. For additional details as to the specific implementations of said methods within \textit{PeleC}, please see the sources referenced throughout, in addition to the general \textit{PeleC} documentation page \cite{} and Github repository \cite{}; the full code is available for download and use. See Appendix \ref{} for input parameters used in this work.  

\section{Finite Volume Formulation} \label{FVM_section}
\textit{PeleC} utilizes a finite volume formulation \cite{} to discretize the system given in Equation \ref{}. First, we re-write a slightly modified version of this system in a condensed tensor notation, where the diffusive fluxes have been moved to the right-hand side of the original expression: 
\begin{equation} \label{NSE_tensor}
\dfrac{\partial \vb{U}}{\partial t} + \nabla \cdot \vb{F} = \nabla \cdot \vb{D}
\end{equation}
where $\vb{U}$ is the vector of conserved quantities $(\rho, \rho \vb{u}, \rho E)$, $\vb{F}$ contains the advective fluxes, and $\vb{D}$ contains the diffusive terms. Note we have dropped the filter notation from the previous section for ease and simplicity of writing but again we are working with the filtered interpretation of the compressible Navier-Stokes Equations as derived in Equation \ref{}. 

In the finite volume formulation, the domain is sub-divided into $i$ cells, each with volume $V_i$. In \textit{PeleC}, these cells are given by boxes in Cartesian coordinates. We then integrate the system in Equation \ref{NSE_tensor} over each finite volume to get the following:
\begin{equation} \label{FVM_app}
\int\limits_{V_i} \dfrac{\partial \vb{U}}{\partial t}\, dV + \int\limits_{V_i} \nabla \cdot \vb{F}\, dV = \int\limits_{V_i} \nabla \cdot \vb{D}\, dV
\end{equation}
In this formulation, a volume average of the state variables are considered through the following definition:
\begin{equation} \label{FVM_avg}
\vb{U}_i = \dfrac{1}{V_i} \int\limits_{V_i} \vb{U} \, dV
\end{equation} 
Applying the definition given by Equation \ref{FVM_avg} to Equation \ref{FVM_app} along with the divergence theorem yields the following:
\begin{equation} \label{FVM}
\dfrac{d\vb{U}_i}{dt} + \dfrac{1}{V_i} \int\limits_{S_i} \vb{F}\cdot \vb{n}\, dS = \dfrac{1}{V_i} \int\limits_{S_i} \vb{D} \cdot \vb{n} \, dS 
\end{equation}
where $S_i$ is the surface of cell $V_i$. To discretize further, the convective and diffusive fluxes must be approximated at the faces of each surface $S_i$ in order to get the total flux contributions to the system:
\begin{equation} \label{FVM_df}
\dfrac{d\vb{U}_i}{dt} +  \dfrac{1}{V_i} \sum\limits_j S_{i,j} \overbar{\vb{F}}_{i,j} =  \dfrac{1}{V_i}\sum\limits_j S_{i,j} \overbar{\vb{D}}_{i,j}
\end{equation}
where $S_{i,j}$ is the $j$-th edge of cell $i$, and corresponding subscripts on fluxes imply flux through that equivalent edge. Further methods may then be applied to perform the flux approximations needed and to discretize in time the system established in Equation \ref{FVM_df}. 

\subsection{Adaptive Mesh Refinement with \textit{AMReX}}
\textit{PeleC} is built in \textit{AMReX} \cite{}, a block-structured hierarchical adaptive mesh refinement library for meshing infrastructure, including grid refinement, distributed parallelism, geometry representation, and output \cite{}. Data management within \textit{AMReX} is generally structured as follows: grids are represented by Boxes. Each Box is associated with a data container known as a FAB. A MultiFAB manages a collection of FABs, which store data at each \gls{amr} level \cite{}. Grids are refinement ratios must be even and equally implemented in each direction. Figure \ref{amr_ex} shows an example of this type of refinement hierarchy using a refinement ratio of two for three levels of mesh refinement. Grid refinement is based on user-specified error criteria. Time scales are also appropriately refined in order to maintain necessary CFL conditions. For further details on \textit{AMReX}, see \cite{}. 

\begin{figure}[h!]
\begin{center}
	\includegraphics[scale=.3]{figures/amr_example.png}
	\caption{2D slice of 3D data demonstrating mesh refinement using \textit{AMReX}. The refinement ratio is 2 and there are 3 levels of mesh refinement.} \label{amr_ex}
\end{center}
\end{figure}

\section{Time-Stepping with Spectral Deferred Correction Methods}
Here we present the general idea behind \gls{sdc} methods as is detailed in \cite{}. Consider an \gls{ode} of the following form: 
\begin{equation} \label{toy_ode}
\begin{split}
\phi_t &= F(\phi(t), t), \quad t \in [t^n, t^{n+1}], \\
\phi(t^n) &= \phi^n 
\end{split}
\end{equation}
with a solution given by the following integral expression:
\begin{equation}
\phi(t) = \phi^n + \int\limits_{t^n}^{t} F(\phi) d\tau
\end{equation}
Then, given an approximation $\phi^{(k)}(t)$ to $\phi(t)$, one can define a residual as follows:
\begin{equation} \label{sdc_residual}
E(t, \phi^{(k)}) = \phi^n + \int\limits_{t^n}^t  F(\phi^{(k)}) d\tau - \phi^{(k)}(t)
\end{equation}
Defining the error to be $\delta^{(k)}(t) = \phi(t) - \phi^{(k)}(t)$, one can then get the error as follows:
\begin{equation} \label{sdc_error}
\delta^{(k)}(t) = \int\limits_{t^n}^{t} \left[ F(\phi^{(k)} + \delta^{(k)}) - F(\phi^{(k)}) \right] d\tau + E(t, \phi^{(k)})
\end{equation}
Now, one can use a higher-order quadrature rule to approximate the integral in Equation \ref{sds_residual}. Along with using a lower-order discretization for the integral in Equation \ref{sdc_error}, an iterative scheme can be constructed through which order of accuracy can be improved over subsequent iterative steps, up to the order of accuracy set by the quadrature. This iteration is defined as $\phi^{(k+1)} = \phi{(k)} + \delta^{(k)}$, and using Equations \ref{sdc_residual} and \ref{sdc_error}, we can write an update as follows:
\begin{equation} \label{sdc_general}
\phi^{(k+1)}(t) = \phi^n + \int\limits_{t^n}^{t} \left[ F(\phi^{(k+1)}) - F(\phi^{(k)}) \right] d\tau + \int\limits_{t^n}^{t}F(\phi^{(k)}) d\tau
\end{equation}
where again the first integral in Equation \ref{sdc_general} is approximated with a low-order discretization and the second integral is approximated using higher-order quadrature. \textit{AMReX} uses ?? quadrature. 

In the \gls{misdc} formulation \cite{}, $F$ in Equation \ref{toy_ode} can be broken up into individual processes: 
\begin{equation} \label{F_decomp}
F \equiv A(\phi) + D(\phi)
\end{equation}
where $A(\phi)$ and $D(\phi)$ are advection and diffusion processes, respectively. Note this decomposition now recovers the system formed through the finite volume formulation of Equation \ref{FVM_df}. This decomposition in general also includes a reaction term, but since our system is a single species with no reactions it is omitted here. These individual processes can now be treated separately. Discussion of flux treatment is given in the next section. For further details on discretizing Equation \ref{sdc_general} with \ref{F_decomp} and applying this to a system of \gls{ode}s as in \ref{FVM_df}, please see \cite{}. For the sake of this work, it is important to note that fluxes can be treated separately in a sort of operator splitting fashion and that accuracy can be set through quadrature choice, which for the methods used here is second-order. 

The \gls{mol} and \gls{sdc} time stepping formulations in \textit{PeleC} share a considerable amount of code. 




\section{Flux Calculations}
Flux approximations are needed at cell faces, as outlined in Section \ref{FVM_section}. Following the methodology outlined in for the \gls{misdc} formulation, both advective and diffusive fluxes are centered in time for part of the iterative process \cite{}. To get the advective fluxes, the \gls{ppm} \cite{} is employed to approximate state values near cell faces where they are then extrapolated to $n+\nicefrac{1}{2}$. These values are then used in an approximate Riemann solver \cite{} to calculate the advective fluxes at cell faces at $n+\nicefrac{1}{s}$. The diffusive fluxes are discretized in space using center difference formulation, with time-centering for the iterator given by the midpoint rule \cite{}. Here we detail the \gls{ppm} a little further and highlight it's advantages for this work.
\subsection{Piecewise Parabolic Method}
\textit{PeleC} houses a few variations of the \gls{ppm}, including the original formulation by Colella and Woodward \cite{}. The one used in this work is the ``extrema preserving" variation of the \gls{ppm} \cite{} in order to aid in the handling of steep density gradients. Here we present the brief outline of the method in one dimension as is done in \cite{} in order to illustrate the general procedure. 

First, the system in Equation \ref{NSE_tensor} is recast in primitive form. In one dimension, this comes out be: 
\begin{equation} \label{NSE_primitive}
\dfrac{\partial \vb{Q}}{\partial t} + \vb{A} \dfrac{\partial \vb{Q}}{\partial x} = \vb{S_Q}
\end{equation}
where vector $\vb{Q}$ houses the primitive variables $(\rho, u, p, \rho e )$, $A$ is the matrix given by $\nicefrac{\partial \vb{F}}{\partial \vb{Q}}$, and $\vb{S_Q}$ is the diffusive terms recast in primitive form. Internal energy is now carried in $\vb{Q}$ to save on the number of calls made to the \gls{eos} during the Riemann solver. In one dimension, $\vb{A}$ is given by: 
\begin{equation} \label{A_1D}
\vb{A} =
 \begin{pmatrix} 
u & \rho & 0 & 0\\
0 & u & \tfrac{1}{\rho} & 0\\
0 & \rho c^2 & u & 0\\
0 & \rho e + p & 0 & u
\end{pmatrix}
\end{equation}
with eigenvalues:
\begin{equation} \label{A_eigenvalues}
\Lambda(\vb{A}) = \{u-c, u, u, u+c\}
\end{equation}
and left row and right column eigenvectors given by: 
\begin{equation} \label{A_eigenvectors}
\vb{l} = 
 \begin{pmatrix} 
0 & - \tfrac{\rho}{2c} & \tfrac{1}{2c^2} & 0\\
1 & 0 & -\tfrac{1}{c^2} & 0\\
0 & 0 & -\tfrac{h}{c^2} & 0\\
0 & \tfrac{\rho}{2c} & \tfrac{\rho}{2c^2} & 0
\end{pmatrix} \quad
\vb{r} = 
 \begin{pmatrix} 
1 & 1 & 0 & 1\\
-\tfrac{c}{\rho} & 0 & 0 & \tfrac{c}{\rho} \\
c^2 & 0 & 0 & c^2\\
h & 0 & 1 & h
\end{pmatrix} 
\end{equation}
where $h$ is the enthalpy and $c$ is the sound speed. 

\subsection{Approximate Riemann Solver}
\section{Discrete \gls{les} Test Filter}
\section{Error}



